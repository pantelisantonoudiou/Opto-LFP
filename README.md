# Opto-LFP/EEG Analysis Data Pipelines

This repository provides two scripts for analyzing optogenetic stimulation experiments using LFP/EEG recordings from LabChart files. The workflow involves detecting stimulation trains, combining them with experimental index metadata, and performing spectral analysis to quantify stimulation effects.

---

## üìë Data Requirements

1. **LabChart files** with the following default channel setup:

   * Channel 1 ‚Üí LFP

   * Channel 2 ‚Üí EEG

   * Channel 3 ‚Üí EMG

   * Channel 4 ‚Üí OPTO-stims

   > ‚ö†Ô∏è The channel structure can change since we are using [SAKE](https://github.com/SAKEverse/sake) to build the index. If multiple animals are stored in the same file, the downstream script that merges stim detections with the SAKE index will need adjustments.

2. **Index file** generated with **SAKE-Plan**:

   * Run SAKE-Plan on your LabChart dataset.
   * Do **not** detect opto comments in SAKE-Plan ‚Äî only detect files.
   * Save the output `index.csv` in the same folder as the LabChart files (the `parent_path`).

---

## ‚öôÔ∏è Installation

The scripts are not packaged as a full Python module yet. Please install dependencies manually.

```bash
# From Conda (scientific stack)
conda install numpy pandas scipy matplotlib seaborn tqdm

# From Pip (LabChart reader + progress)
pip install adi-reader tqdm

# (Optional) Install Spyder IDE
conda install spyder
```

> Many of these dependencies are common in base Conda environments, so try running the scripts first ‚Äî install missing ones as needed.

---

## üìÇ Scripts

### 1. `combine_index_with_optostim.py`

Detects optogenetic stim trains from LabChart files and merges them with the **SAKE index**.

**Workflow:**

1. Reads `index.csv` from the parent folder.
2. Detects stimulation trains using `parse_stims()`.
3. Merges detected stim frequencies and timing with the original index.
4. Saves `combined_index.csv` in the same folder.

**Inputs (prompted at runtime):**

* `parent_path` ‚Üí folder containing LabChart files and `index.csv`.
* `index.csv` ‚Üí defaults to `index.csv` in `parent_path`.
* `stim_ch` ‚Üí stimulation channel number (default = 4).

**Output:**

* `combined_index.csv` containing stim frequencies (`stim_hz`) alongside the SAKE index.

---

### 2. `analyze_opto_lfp.py`

Performs time-frequency analysis to compare **stim vs. baseline** LFP power.

**Workflow:**

1. Loads `combined_index.csv` generated by the previous script.
2. Extracts stim and baseline segments for each row.
3. Removes outliers (percentile-based interpolation).
4. Computes STFT-based power spectra.
5. Calculates:

   * **`power_ratio`** = (stim power / baseline power).
   * **`peak_freq`** = peak frequency in baseline PSD.
6. Produces seaborn plots showing power ratio vs. stim frequency.

**Configurable variables (edit in script):**

* `main_path` ‚Üí parent folder path containing `combined_index.csv`.
* `win` ‚Üí STFT window size (seconds).
* `overlap` ‚Üí fraction of overlap between STFT windows.
* `f_range` ‚Üí frequency range for peak frequency analysis.
* `outlier_threshold` ‚Üí lower/upper percentiles for outlier removal.
* `baseline_time` ‚Üí duration of baseline segment before stim onset (s).
* `stim_bins`, `stim_labels` ‚Üí bins and labels for mapping stim frequencies.

**Output:**

* Updated dataframe (`index`) with `power_ratio` and `peak_freq` columns.
* Line plots:

  * Per-animal power ratios (colored by `animal_id`).
  * Averaged per-brain-region ratios.
* Both plots include a note: *"Press 'L' in the plot window to toggle log scale"*.

---

## ‚ñ∂Ô∏è Usage

1. Run stim detection and index merging:

   ```bash
   python combine_index_with_optostim.py
   ```

   Provide `parent_path`, `index.csv`, and stim channel when prompted.

2. Run spectral analysis and plotting:

   ```bash
   python analyze_opto_lfp.py
   ```

   (Recommended to run inside Spyder or another IDE for data exploration.)

---

## üìä Data Flow

```
[index.csv] --SAKE--> [parent_path/index.csv]
         \
          combine_index_with_optostim.py --> [combined_index.csv]
                                           \
                                            analyze_opto_lfp.py --> plots + enriched index
```

---

## üìù Notes

* Each LabChart file should represent **one animal**. For multi-animal files, modify the `combine_index_with_optostim.py` script accordingly.
* Outputs are meant for **exploratory data analysis**, not as a polished software package.
* Running spectral analysis (`analyze_opto_lfp.py`) from Spyder is recommended for easier exploration and interactive plotting.
